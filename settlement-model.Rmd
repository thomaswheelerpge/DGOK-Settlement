---
output: 
  html_document:
    code_folding: hide
    warning: FALSE
---

# DOPD Settlement Model

## Overview

This R script is a reconstruction of 2 Excel-based models which calculate daily payouts for PGE and DOPD in accordance with the XXX agreement.

The goal of this script is to reduce the amount of human interaction needed to run the model in an effort to reduce time spent on the modeling task and prevent potential human error.

This script will have a companion app where a user can enter parameters into an easy to use interface and run the model. The model can also be run directly here in R.

## Section 1: Import libraries and model parameters

#### Import libraries

```{r, warning=FALSE, message=FALSE}

library(tidyverse)
library(dplyr)
library(readxl)

```

#### Import parameters shared across both models

```{r}

# Import 'Curves' sheet from within data.xlsx

curves_data <- read_excel('data.xlsx', sheet = "Curves") %>%
  mutate(Date = as.Date(Date, format = "%Y-%m-%d"))

# Import 'SHARES' sheet from within data.xlsx

shares_data <- read_excel('data.xlsx', sheet = 'SHARES')

# Import 'RTDATA' sheet from within data.xlsx

rt_data <- read_excel('data.xlsx', sheet = 'RTDATA')

```

#### Manually enter parameters shared across both models

```{r}

# Rocky Reach Spill

rrh_spill <- 0

```


#### Manually enter parameters that are unique to DOPD model

```{r}

# The day to run the DOPD model. This will determine what day of pricing for MIDC and POWERDEX will be pulled.
# Dashboard Question: What day do you want to run the DOPD model for?

dopd_flow_date <- as.Date("2023-10-12", format = "%Y-%m-%d")

# DOPD's share of Wells Dam on DOPD model run day

dopd_wells_percentage <- 0.2778 # NOTE: CAN BE PULLED IN VIA VLOOKUP FROM 'SHARES' sheet instead of manually entered in the future if desired

# DOPD's share of Rocky Reach Dam on DOPD model run day

dopd_rrh_percentage <- 0.0554 # NOTE: CAN BE PULLED IN VIA VLOOKUP FROM 'SHARES' sheet instead of manually entered in the future if desired


```


#### Manually enter parameters that are unique to OKPD model

Note: These parameters are all currently being entered in manually, but could be pulled via a spreadsheet or function in the future

```{r}

# The day to run the OKPD model. This will determine what day of pricing for MIDC and POWERDEX will be pulled.
# Dashboard Question: What day do you want to run the OKPD model for?

okpd_flow_date <- as.Date("2023-10-12", format = "%Y-%m-%d")

# OKPD's share of Rocky Reach Dam on model run day

okpd_rrh_percentage <- 0.0917 # NOTE: CAN BE PULLED IN VIA VLOOKUP FROM 'SHARES' sheet instead of manually entered

```

## Section 2: Run model

#### Set up model dataframe

Explained plainly: In this code chunk we are setting up the main data frame that will be used to calculate the final settlement value and begin by adding in Hours 1 through 24 as well as the MIDC ICE & POWERDEX Prices. 

Corresponding Excel cells from DG PGE STLMNT that are created in this code chunk below -> C36:Z38

```{r}

# Filter curves_data to extract MIDC ICE and POWERDEX Prices

curves_data_filtered <- curves_data %>% filter(Date == dopd_flow_date)

# Create main dataframe for housing model outputs

df <- tibble(
  Hour = 1:24,
  `MIDC ICE Price` = curves_data_filtered$`ICE DA MidC`,
  POWERDEX = curves_data_filtered$`Powerdex MidC`
)

```

#### Calculate Wells Max Values

```{r}

rt_data_tidy <- rt_data %>%
  # Move row value into one column for easier querying
  pivot_longer(cols = 3:ncol(rt_data), names_to = "Hour", values_to = "Value") %>% 
  # Convert hourly string values to numeric
  mutate(Hour = as.numeric(sub("^HE", "", Hour)))  %>%
  # Drop any NA values in the Hour column (These are the "Day Total" values)
  filter(!is.na(Hour))

rt_data_wel_tot_cap <- rt_data_tidy %>% 
  # Filter by WEL TOT CAP
  filter(account == "WEL TOT CAP")

rt_data_wells_obligations_net_schd <- rt_data_tidy %>% 
  # Filter by WELLS OBLIGATIONS NET SCHD
  filter(account == "WELLS OBLIGATIONS NET SCHD")

rt_data_wells_max <- 
  # Join WEL TOT CAP and WELLS OBLIGATIONS NET SCHD by Hour
  left_join(rt_data_wel_tot_cap, rt_data_wells_obligations_net_schd, by = "Hour") %>% 
  # Calculate Wells Max (= DOPD's percentage of Wells * (WEL TOT CAP - WELLS OBLIGATION NET SCHD))
  # NOTE: Values are conditionally checked to be set to zero of values are less than or equal to 0
  mutate(`Wells Max` = dopd_wells_percentage * 
           (ifelse(Value.x <= 0, 0, Value.x) - ifelse(Value.y <= 0, 0, Value.y)))

# Add Wells Max values to the main df
df <- df %>% mutate(`Wells Max` = rt_data_wells_max$`Wells Max`)
```

#### Calculate Wells Min Values

```{r}
rt_data_forecast_wells_generation_min_mw <- rt_data_tidy %>% 
  # Filter by forecast.wells.generation.min-m
  filter(account == "forecast.wells.generation.min-mw")

rt_data_wells_min <- 
  # Join forecast.wells.generation.min-m and WELLS OBLIGATIONS NET SCHD by Hour
  left_join(rt_data_forecast_wells_generation_min_mw, rt_data_wells_obligations_net_schd, by = "Hour") %>% 
  # Calculate Wells Min (= DOPD's percentage of Wells * (forecast.wells.generation.min-m - WELLS OBLIGATION NET SCHD))
  # NOTE: Values are conditionally checked to be set to zero of values are less than or equal to 0
  mutate(`Wells Min` = dopd_wells_percentage * 
           (ifelse(Value.x <= 0, 0, Value.x) - ifelse(Value.y <= 0, 0, Value.y)))

# Add Wells Min values to the main df
df <- df %>% mutate(`Wells Min` = rt_data_wells_min$`Wells Min`)
```

#### Calculate RRH Max

```{r}
rt_data_part_total_max_capacity <- rt_data_tidy %>% filter(account == "PART_TOTAL_MAX_CAPACITY_MW-DGLS01")
```


